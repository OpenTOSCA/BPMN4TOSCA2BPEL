#foreach( $mngmtTask in $mngmtTaskList)

#set( $taskName = $mngmtTask.getName() )
#set( $taskInterface = $mngmtTask.getInterfaceName() )
#set( $taskOperation = $mngmtTask.getNodeOperation() )
#set( $taskNodeTemplate = $mngmtTask.getNodeTemplateId() )
#set( $taskInputTargetNodeTemplateSet = $mngmtTask.getInputNodeTemplateIds() )
#set( $taskOutputTargetNodeTemplateSet = $mngmtTask.getOutputNodeTemplateIds() )
#set( $inputOutputNodeTemplateSet = $mngmtTask.getAllNodeTemplateIds()  )
#set( $taskInputDataList  = $mngmtTask.getInputParameters() )
#set( $taskOutputDataList  = $mngmtTask.getOutputParameters() )


<scope name="${taskName}" xmlns:pp="http://opentosca.org/api/pp"
	xmlns:xlink="http://www.w3.org/1999/xlink">

	<!-- Template requires global variable 'serviceInstanceId'
	     Template defines following placeholders:
	     $mngmt_scope_name - Should become the name of the management task
	     $taskInputTargetNodeTemplateSet - All ids of node templates where input data for management operation are retrieved from
	     $taskOutputTargetNodeTemplateSet - All ids of node templates where output data of management operation are written to
	     $inputOutputNodeTemplateSet - All node template ids accessed by management operation, i.e. 
	    							   set union of $taskInputTargetNodeTemplateSet and $taskOutputTargetNodeTemplateSet
	     $taskInputDataList - All input data of management operation
	     $taskOutputDataList - All output data of management operation
	  -->

	<variables>
		<!-- Must contain a <pp:nodeInstanceList> element with exactly one child 
			<pp::nodeinstances> which contains exactly one child named <pp:link href="nodeInstanceId"> -->
		<variable name="nodeInstanceUrlList" type="xsd:anyType" /> <!-- TODO set correct type -->
		<variable name="nodeInstanceUrl" type="xsd:string" />
		<variable name="mangementOperationRequest" messageType="si:invokeOperationAsyncMessage" />
		<variable name="mangementOperationResponse" messageType="si:invokeResponse" />
		
		<!--  Variables holding the URLs of node instances of node templates and their properties  -->
		#foreach($nodeTemplateId in $inputOutputNodeTemplateSet)
			<variable name="nodeInstanceUrl_$nodeTemplateId" type="xsd:string" />
			<variable name="properties_$nodeTemplateId" type="xsd:anyType" />
		#end
	

	</variables>
	<sequence name="${taskName}_Sequence">

	
		<!-- Retrieve node instance URLs of instance of all nodes templates used either as input and output of this management operation -->
		#foreach($nodeTemplateId in $inputOutputNodeTemplateSet)
			<extensionActivity>
				<bpel4RestLight:GET name="getNodeInstanceList"
					accept="application/xml" response="nodeInstanceUrlList"
					uri="${bpelvar}[instanceDataAPIUrl]/nodeInstances?nodeTemplateID=$nodeTemplateId&amp;serviceInstanceID=${bpelvar}[serviceInstanceId]" />
			</extensionActivity>
		
			<!-- Select the node instance to be managed from the list - just one node 
				instance expected in the list -->
			<assign name="selectNodeInstanceIdFromList" validate="no">
				<copy>
					<from variable="nodeInstanceUrlList">
						<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[string(//pp:NodeInstanceList/pp:nodeinstances/pp:link/@xlink:href)]]></query>
					</from>
					<to variable="nodeInstanceUrl_$nodeTemplateId" />
				</copy>
			</assign>
		#end
		
		
		
		#foreach($inputNodeTemplateId in $taskInputSourceNodeTemplateSet)
		<!-- Get properties of node instance and store it in the corresponding 
			variable -->
			<extensionActivity>
				<bpel4RestLight:GET 
					name="getNodeInstanceProperties_$inputNodeTemplateId"
					accept="application/xml"
					response="properties_$inputNodeTemplateId" 
					uri="${bpelvar}[nodeInstanceUrl_$inputNodeTemplateId]/properties" />
			</extensionActivity>

		#end

		<!-- Create input message for task $taskName -->
		<assign name="createManagementOperationInput" validate="no">
			<!-- Initialize input variable for asynch. call  -->
			<copy>
				<from>
					<literal>
						<impl:invokeOperationAsync xmlns:impl="http://siserver.org/schema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
							<impl:CsarID></impl:CsarID>
		
							<impl:ServiceTemplateIDNamespaceURI></impl:ServiceTemplateIDNamespaceURI>
							<impl:ServiceTemplateIDLocalPart></impl:ServiceTemplateIDLocalPart>
							<impl:InterfaceName></impl:InterfaceName>
							<impl:NodeTemplateID></impl:NodeTemplateID>
							<impl:OperationName></impl:OperationName>
							<impl:ReplyTo/>
							<impl:MessageID></impl:MessageID>
							<impl:Params>
								<!-- Create input parameters (payload) skeleton where the task input parameter values will be assigned to  -->
								#foreach( $taskInput in $mngmtTaskInputList)
									<impl:Param>
		                                <impl:key>$taskInput.name</impl:key>
		                                <impl:value></impl:value> 
		                            </impl:Param>
								#end	
		                    </impl:Params>
						</impl:invokeOperationAsync>
					</literal>
				</from>
				<to variable="mangementOperationRequest" part="invokeOperationAsync" />
			</copy> 
			<copy>
				<from variable="csarId" /> <!-- TODO frage an Olly: assigne dder hier jetzt nur den content oder die 
					ganze variable mit tags, in BPELDesigner checken -->
				<to variable="mangementOperationRequest" part="invokeOperationAsync">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//si:invokeOperationAsync/si:CsarID]]></query>
				</to>
			</copy>
			<copy>
				<from>
					<literal>
						$taskNodeTemplate
					</literal>
				</from>
				<to variable="mangementOperationRequest" part="invokeOperationAsync">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//si:invokeOperationAsync/si:NodeTemplateID]]></query>
				</to>
			</copy>
			<copy>
				<from>
					<literal>
						$taskInterface
					</literal>
				</from>
				<to variable="mangementOperationRequest" part="invokeOperationAsync">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//si:invokeOperationAsync/si:InterfaceName]]></query>
				</to>
			</copy>
			<copy>
				<from>
					<literal>
						$taskOperation
					</literal>
				</from>
				<to variable="mangementOperationRequest" part="invokeOperationAsync">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//si:invokeOperationAsync/si:OperationName]]></query>
				</to>
			</copy>
			<copy>
				<from variable="serviceTemplateIdNamespaceURI" />
				<to variable="mangementOperationRequest" part="invokeOperationAsync">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//si:invokeOperationAsync/si:ServiceTemplateIDNamespaceURI]]></query>
				</to>
			</copy>
			<copy>
				<from variable="serviceTemplateIdLocalPart" />
				<to variable="mangementOperationRequest" part="invokeOperationAsync">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//si:invokeOperationAsync/si:ServiceTemplateIDLocalPart]]></query>
				</to>
			</copy>
			<!-- The callback plan URL is provided in the message body and in the "ReplyTo" header TODO why in both?-->
			<copy>
				<from variable="planCallbackUrl" />
				<to variable="mangementOperationRequest" part="invokeOperationAsync">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//*[local-name()="ReplyTo" and namespace-uri()="http://siserver.org/schema"]]]></query>
				</to>
			</copy>
			<!-- <copy>
				<from variable="planCallbackUrl" />
				<to variable="mangementOperationRequest" header="ReplyTo" />
			</copy>  -->
			<copy>
				<!-- Generate unique message id used for correlation -->
				<from> 
					$ode:pid
				</from>
				<to variable="mangementOperationRequest" part="invokeOperationAsync">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//si:invokeOperationAsync/si:MessageID]]></query>
				</to>
			</copy>
			<!-- Copy the property values from the node instances retrieved before, to the task input parameters  -->
			#foreach($taskInputData in $mngmtTaskInputDataList)
				<copy>
					<from variable="properties_$taskInputData.nodeTemplate">
						<!-- Select relevant property from node instance properties and add it to the parameters list -->
						<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[string(//*[local-name()='$taskInputData.property'])]]></query>
					</from>
					<to  variable="mangementOperationRequest" part="invokeOperationAsync">
						<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//*[local-name()="Param" and namespace-uri()="http://siserver.org/schema"]/*[local-name()="key" and text()="$taskInput.name"]/following-sibling::*[local-name()="value"]]]></query>
					</to>
				</copy>
			#end
			
		</assign>
		
		<!-- Call Service Invoker asynchronously  -->
		<invoke name="call_${taskName}"
			inputVariable="mangementOperationRequest"
			operation="invokeOperationAsync" 
			partnerLink="serviceInvokerPL"
			portType="si:InvokePortType">
			<correlations>
				<correlation initiate="join" set="ServiceInvokerCS" />
			</correlations>
		</invoke>
		
		<!-- Receive asynchronous response from Service Invoker  -->
		<receive name="receive_${taskName}_response"
			variable="mangementOperationResponse"
			operation="callback" 
			partnerLink="serviceInvokerPL" 
			portType="si:CallbackPortType">
			<correlations>
				<correlation initiate="no" set="ServiceInvokerCS" />
			</correlations>
		</receive>
		
		#foreach($outputNodeTemplateId in $taskOutputTargetNodeTemplateSet)
			<!-- Get properties of node instance and store it in the corresponding variable -->
			<extensionActivity>
				<bpel4RestLight:GET accept="application/xml" name="getNodeInstanceProperties_$outputNodeTemplateId"
					response="properties_$outputNodeTemplateId " uri="${bpelvar}[nodeInstanceUrl_$outputNodeTemplateId ]/properties" />
			</extensionActivity>
		#end
		
		
		
		<!--Copy result of management operation to variables representing properties of node template  -->
		#foreach($taskOutputData in $taskOutputDataList)
		<assign name="copyOutputProperty_$taskOutputData.property">
			<copy>
				<from variable="mangementOperationResponse">
					<!-- Select relevant property from node instance properties and add it 
						to the parameters list -->
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//*[local-name()='$taskOutputData.name']]]></query>
				</from>
				<to variable="properties_$taskOutputData.nodeTemplate">
					<query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0"><![CDATA[//*[local-name()="Param" and namespace-uri()="http://siserver.org/schema"]/*[local-name()="key" and text()="$taskOutputData.property"]/following-sibling::*[local-name()="value"]]]></query>
				</to>
			</copy>
		</assign>
		#end

		<!-- Store result of management operation, i.e. node template properties in container -->
		#foreach($outputNodeTemplateId in $taskOutputTargetNodeTemplateSet)
			<extensionActivity>
				<bpel4RestLight:PUT accept="application/xml" 
					request="properties_$outputNodeTemplateId" 
					uri="${bpelvar}[nodeInstanceUrl_$outputNodeTemplateId]/properties"/>
			</extensionActivity>
		#end

	</sequence>
</scope>

#end
